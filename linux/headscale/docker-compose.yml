version: '3.3'

services:
  headscale:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: headscale
    restart: unless-stopped
    user: root
    ports:
      - "${HEADSCALE_METRICS_PORT:-9090}:9090"
      - "${HEADSCALE_GRPC_PORT:-50443}:50443"
      - "${HEADSCALE_STUN_PORT:-3478}:3478/udp"
      - "${HEADSCALE_PORT:-8080}:8080"
    volumes:
      - /opt/headscale/config/config.yaml:/etc/headscale/config.yaml:ro
      - /opt/headscale/config/derp.yaml:/etc/headscale/derp.yaml:ro
      - /opt/headscale/config/tls.crt:/opt/headscale/config/tls.crt:ro
      - /opt/headscale/config/tls.key:/opt/headscale/config/tls.key:ro
      - /opt/headscale/data:/var/lib/headscale
      - /opt/headscale/run:/var/run/headscale
    networks:
      headscale-network:
        ipv4_address: ${HEADSCALE_IP:-172.28.0.10}
        aliases:
          - headscale
          - headscale-api

  headscale-ui:
    image: ghcr.io/gurucomputing/headscale-ui:2025.08.23
    container_name: headscale-ui
    restart: unless-stopped
    environment:
      # 让前端通过 Caddy 代理访问 API，解决 HTTPS 问题
      - HS_SERVER=http://${SERVER_HOST}:${UI_HTTP_PORT}
    depends_on:
      - headscale
    networks:
      headscale-network:
        ipv4_address: ${HEADSCALE_UI_IP:-172.28.0.20}
        aliases:
          - headscale-ui

  caddy:
    image: caddy:2.10.2
    container_name: caddy
    restart: unless-stopped
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-8443}:8443"
      - "${UI_HTTP_PORT:-8008}:8008"
      - "${UI_API_PORT:-8081}:8081"
    volumes:
      - /opt/caddy/config/Caddyfile:/etc/caddy/Caddyfile:ro
      - /opt/caddy/data:/data
      - /opt/headscale/config/tls.crt:/opt/headscale/config/tls.crt:ro
      - /opt/headscale/config/tls.key:/opt/headscale/config/tls.key:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "headscale:${HEADSCALE_IP:-172.28.0.10}"
      - "headscale-ui:${HEADSCALE_UI_IP:-172.28.0.20}"
    networks:
      headscale-network:
        ipv4_address: ${CADDY_IP:-172.28.0.30}
    depends_on:
      - headscale
      - headscale-ui

networks:
  headscale-network:
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-172.28.0.0/16}
