version: '3.3'

services:
  headscale:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: headscale
    restart: unless-stopped
    user: root
    # 端口说明：
    # - 9090: Metrics（可选）
    # - 50443: gRPC（可选）
    # - 3478/udp: STUN/DERP（必须，用于 NAT 穿透）
    # - 8080 已被 Caddy 占用，Headscale 使用内部端口 8081
    ports:
      - "${HEADSCALE_METRICS_PORT:-9090}:9090"
      - "${HEADSCALE_GRPC_PORT:-50443}:50443"
      - "${HEADSCALE_STUN_PORT:-3478}:3478/udp"
    # expose 用于内部网络通信，不映射到宿主机
    expose:
      - "8081"
    volumes:
      - /opt/headscale/config/config.yaml:/etc/headscale/config.yaml:ro
      - /opt/headscale/config/derp.yaml:/etc/headscale/derp.yaml:ro
      - /opt/headscale/data:/var/lib/headscale
      - /opt/headscale/run:/var/run/headscale
    networks:
      headscale-network:
        ipv4_address: ${HEADSCALE_IP:-172.28.0.10}
        aliases:
          - headscale
          - headscale-api

  caddy:
    image: caddy:2.10.2
    container_name: caddy
    restart: unless-stopped
    # 端口说明：
    # - 80: HTTP（可选，用于重定向或基础服务）
    # - 8080: HTTPS（必须，供 Tailscale 客户端连接）
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-8080}:8080"
    volumes:
      - /opt/caddy/config/Caddyfile:/etc/caddy/Caddyfile:ro
      - /opt/caddy/data:/data
      - /opt/headscale/config/tls.crt:/opt/headscale/config/tls.crt:ro
      - /opt/headscale/config/tls.key:/opt/headscale/config/tls.key:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "headscale:${HEADSCALE_IP:-172.28.0.10}"
    networks:
      headscale-network:
        ipv4_address: ${CADDY_IP:-172.28.0.30}
    depends_on:
      - headscale

networks:
  headscale-network:
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-172.28.0.0/16}
